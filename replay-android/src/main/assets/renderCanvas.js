var renderCanvas;(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{async function r(e,t,r){await Promise.all([...n(e,t.audioFileNames||[],r.audioElements,r.loadAudioFile),...n(e,t.imageFileNames||[],r.imageElements,(e=>r.loadImageFile(e,!1))),...n(e,t.imageFileNamesScaleNearestPixel||[],r.imageElements,(e=>r.loadImageFile(e,!0)))])}function n(e,t,r,n){return t.map((t=>{if(r[t]){r[t].globalSpriteIds.push(e);const{data:n}=r[t];return"then"in n?n:Promise.resolve()}const i=n(t).then((e=>{r[t].data=e}));return r[t]={globalSpriteIds:[e],data:i},i}))}function i(e,t){a(e,t.audioElements,t.cleanupAudioFile),a(e,t.imageElements,t.cleanupImageFile)}function a(e,t,r){for(const n in t){const{globalSpriteIds:i}=t[n],a=i.indexOf(e);-1!==a&&(1===i.length?(r(n),delete t[n]):t[n].globalSpriteIds.splice(a,1))}}function o(e){var t,r,n;return{x:e.x||0,y:e.y||0,rotation:e.rotation||0,opacity:Math.min(1,Math.max(0,null!==(t=e.opacity)&&void 0!==t?t:1)),scaleX:null!==(r=e.scaleX)&&void 0!==r?r:1,scaleY:null!==(n=e.scaleY)&&void 0!==n?n:1,anchorX:e.anchorX||0,anchorY:e.anchorY||0,mask:e.mask||null,show:e.show||!0}}function s(e,t){var r,n,i,a;const o=e;return o.x=t.x||0,o.y=t.y||0,o.rotation=t.rotation||0,o.opacity=Math.min(1,Math.max(0,null!==(r=t.opacity)&&void 0!==r?r:1)),o.scaleX=null!==(n=t.scaleX)&&void 0!==n?n:1,o.scaleY=null!==(i=t.scaleY)&&void 0!==i?i:1,o.anchorX=t.anchorX||0,o.anchorY=t.anchorY||0,o.mask=t.mask||null,o.show=null===(a=t.show)||void 0===a||a,o}function l(e,t){var r;switch(e.type){case"rectangleArray":{const e=t;return s({testId:e.testId,width:e.width||10,height:e.height||10,color:e.color||"black"},e)}case"textArray":{const e=t;return s({testId:e.testId,font:e.font,text:e.text||"",color:e.color||"black",gradient:e.gradient,strokeColor:e.strokeColor,strokeThickness:e.strokeThickness},e)}case"circleArray":{const e=t;return s({testId:e.testId,radius:e.radius||10,color:e.color||"black",gradient:e.gradient},e)}case"lineArray":{const e=t;return s({testId:e.testId,color:e.color,fillColor:e.fillColor,thickness:null!==(r=e.thickness)&&void 0!==r?r:1,lineCap:e.lineCap||"butt",path:e.path||[],gradient:e.gradient,fillGradient:e.fillGradient},e)}case"imageArray":{const e=t;return s({testId:e.testId,width:e.width||10,height:e.height||10},e)}}}e.r(t),e.d(t,{run:()=>ce});const c={identityMatrix:[1,0,0,1,0,0],getNewIdentity3fv:function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},getScaleMatrix:function(e,t){return[e,0,0,t,0,0]},getTranslateMatrix:function(e,t){return[1,0,0,1,e,t]},multiply:function(e,t){const r=e[0],n=e[1],i=e[2],a=e[3],o=e[4],s=e[5],l=t[0],c=t[1],u=t[2],d=t[3],p=t[4],f=t[5];return[r*l+i*c,n*l+a*c,r*u+i*d,n*u+a*d,r*p+i*f+o,n*p+a*f+s]},transformMut:function(e,t,r,n,i,a,o,s,l,c,u){const d=Math.cos(a),p=Math.sin(a),f=e[0],m=e[1],h=e[2],g=e[3],y=e[4],v=e[5],x=l*d*n,A=l*p*n,_=c*-p*i,b=c*d*i,S=d*n*o-p*i*s+t,E=p*n*o+d*i*s+r;u[0]=f*x+h*A,u[1]=m*x+g*A,u[2]=f*_+h*b,u[3]=m*_+g*b,u[4]=f*S+h*E+y,u[5]=m*S+g*E+v},toUniform3fvMut:function(e,t){t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1},scaleToUniform3fvMut:function(e,t,r,n){const i=e[0],a=e[1],o=e[2],s=e[3],l=e[4],c=e[5];n[0]=i*t,n[1]=a*t,n[2]=0,n[3]=o*r,n[4]=s*r,n[5]=0,n[6]=l,n[7]=c,n[8]=1},multiplyPooled:function(e,t){const r=e[0],n=e[1],i=e[2],a=e[3],o=e[4],s=e[5],l=t[0],c=t[1],d=t[2],p=t[3],f=t[4],m=t[5];return u[0]=r*l+i*c,u[1]=n*l+a*c,u[2]=r*d+i*p,u[3]=n*d+a*p,u[4]=r*f+i*m+o,u[5]=n*f+a*m+s,u},getTranslateMatrixPooled:function(e,t){return d[4]=e,d[5]=t,d},getScaleMatrixPooled:function(e,t){return p[0]=e,p[3]=t,p},getRotateMatrixPooled:function(e){const t=Math.sin(e),r=Math.cos(e);return f[0]=r,f[1]=t,f[2]=-t,f[3]=r,f},getScalePooled:function(e){return m.scaleX=Math.hypot(e[0],e[2]),m.scaleY=Math.hypot(e[1],e[3]),m},invertPooled:function(e){const t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5];let s=t*i-r*n;return s?(s=1/s,h[0]=i*s,h[1]=-r*s,h[2]=-n*s,h[3]=t*s,h[4]=(n*o-i*a)*s,h[5]=(r*a-t*o)*s,h):null}},u=[0,0,0,0,0,0],d=[1,0,0,1,0,0],p=[0,0,0,0,0,0],f=[0,0,0,0,0,0],m={scaleX:0,scaleY:0},h=[0,0,0,0,0,0];function g(e,t,r,n=1,i=1){c.transformMut(e,r.x,r.y,r.scaleX,r.scaleY,-r.rotation*x,-r.anchorX,-r.anchorY,n,i,t)}const y=[0,0,0,0,0,0];function v(e,t,r=1,n=1){return g(e,y,t,r,n),y}const x=Math.PI/180;function A(e,t,r,n,i,a,o,l,c,u,d,p,f,m){const{baseProps:h}=e;s(h,t);const g=n.addToStack(h),y=e.getSprites(t,g,o,l,c,m),v=e.prevChildIdsSet,x=e.prevChildIds;let A=0;p.startRenderSprite(h,g,null),b(y,e,r,n,i,a,l,c,u,d,p,f,m,(e=>{x[A]=e,A++,v.delete(e)})),p.endRenderSprite(n.removeFromStack()),A<x.length&&(x.length=A);for(const t of v)_({[t]:e.childContainers[t]},u,r),delete e.childContainers[t];e.prevChildIdsSet.clear();for(const t of x)e.prevChildIdsSet.add(t);if(e.prevChildIdsSet.size<x.length){const e=x.find(((e,t)=>x.indexOf(e)!==t));throw Error(`Duplicate Sprite id ${e}`)}}function _(e,t,r){for(const n in e){const a=e[n];if("custom"===a.type){const e=`${t}--${n}`;_(a.childContainers,e,r),a.loadFilesPromise&&a.loadFilesPromise.then((()=>{i(e,r.assetUtils)}))}a.cleanup()}}function b(e,t,r,n,i,a,o,s,l,u,d,p,f,m){for(let h=0;h<e.length;h++){const g=e[h];if(g)if("context"===g.type)b(g.sprites,t,r,n,i,a,o,s,l,u,d,p,[...f,g],m);else if("native"===g.type){m(g.props.id);const{nativeSpriteMap:e,nativeSpriteUtils:r}=u,i=e[g.name];if(!i)throw Error(`Cannot find Native Sprite "${g.name}"`);let a=t.childContainers[g.props.id];if(!a||"native"!==a.type){const e={type:"native",props:g.props,state:i.create({props:g.props,parentGlobalId:l,getState:()=>e.state,utils:r}),updateSprite(){d.startNativeSprite(),i.loop({props:e.props,state:e.state,parentGlobalId:l,utils:r,spriteToGameCoords:(e,t,r)=>{const i=c.multiplyPooled(n.getTopStack().transformationGameCoords,c.getTranslateMatrixPooled(e,t));r.x=i[4],r.y=i[5]}}),d.endNativeSprite()},cleanup(){i.cleanup({state:this.state,parentGlobalId:l})}};t.childContainers[g.props.id]=e,a=e}a.props=g.props,a.updateSprite()}else if("pure"===g.type){m(g.props.id);let e=t.childContainers[g.props.id];e&&"pure"===e.type||(e=P(g),t.childContainers[g.props.id]=e),F(e,g.props,n,r.size,u.nativeSpriteUtils.didResize,o,d)}else if("custom"===g.type){m(g.props.id);let e=!1,c=t.childContainers[g.props.id];const h=`${l}--${g.props.id}`;c&&"custom"===c.type||(e=!0,c=E(g,r,i,a,n,t.prevTime,h,f),t.childContainers[g.props.id]=c),A(c,g.props,r,n,i,a,e,o,s,h,u,d,p,f)}else if("mutable"===g.type){if(!g.props.id)throw Error("Mutable sprite must have id prop in non-Mutable Sprites");m(g.props.id);let e=t.childContainers[g.props.id];const o=`${l}--${g.props.id}`;let s=!1;if(!e||"mutable"!==e.type){if(s=!0,e=R(g,r,n,i,a,t.prevTime,o,[],d,p,u),"mutable"!==e.type)throw Error("Can only render mutable Sprite");t.childContainers[g.props.id]=e}for(const t in g.props)e.props[t]=g.props[t];const c=n.addToStack(e.props);d.startRenderSprite(e.props,c,e.maskState),e.updateSprites(s),d.endRenderSprite(n.removeFromStack())}else d.renderTexture(n.getTopStack(),g,d.getInitTextureState(g),null)}}const S=1/60*1e3;function E(e,t,n,i,a,s,l,c){const{spriteObj:u,props:d}=e,p=[],f=e=>{p.push(e)};let m,h=null,g=null;u.init&&(m=u.init({props:d,getState:()=>{if(!h)throw Error("Cannot call getState synchronously in init");return h.state},device:t,getInputs:()=>n(a.getStack((null==h?void 0:h.stackIndex)||0).transformationGameCoords,(null==h?void 0:h.inputs)||i()),updateState:f,getContext:e=>{const t=c.find((t=>t.context===e));if(!t)throw Error("No context setup");return t.value},preloadFiles:async e=>{const n=r(l,e,t.assetUtils);h?h.loadFilesPromise=n:g=n,await n}}));const y=()=>{let e=0;for(;e<p.length;){const t=p[e];h.state=t(h.state),e++}p.length=0},v=()=>h.state;return h={type:"custom",state:m,inputs:i(),baseProps:o(d),childContainers:{},prevChildIds:[],prevChildIdsSet:new Set,prevTime:s,currentLag:0,loadFilesPromise:g,stackIndex:null,getSprites(e,r,i,o,s,l){y(),null===this.stackIndex&&(this.stackIndex=a.getStackIndex());const c=e=>{const t=l.find((t=>t.context===e));if(!t)throw Error("No context setup");return t.value};!i&&u.loop&&(this.state=u.loop({props:e,state:this.state,device:t,getInputs:()=>n(r.transformationGameCoords,this.inputs),updateState:f,getState:v,getContext:c})),y();let d=u[o];d||(d="renderPXL"===o&&u.renderXL?u.renderXL:u.render);const p=d({props:e,state:this.state,device:t,getInputs:()=>n(r.transformationGameCoords,this.inputs),updateState:f,getState:v,getContext:c,extrapolateFactor:s});return y(),p},cleanup(){var e;null===(e=u.cleanup)||void 0===e||e.call(u,{state:this.state,device:t})}},h}function w(e,t){const r=e.deviceHeight>e.deviceWidth;let n,i=!1;return"portrait"in t?(n=r?t.portrait:t.landscape,i=!0):n=t,n.minHeightXL&&e.deviceHeight>=n.minHeightXL||n.minWidthXL&&e.deviceWidth>=n.minWidthXL?i&&r?"renderPXL":"renderXL":i&&r?"renderP":"render"}function T(e,t,r,n){switch(e.type){case"mutable":e.updateSelf();const i=r.addToStack(e.props);t.startRenderSprite(e.props,i,e.maskState),e.updateSprites(n),t.endRenderSprite(r.removeFromStack());break;case"mutableArray":e.updateSprites();for(const i in e.containersArray){const a=e.containersArray[i],o=r.addToStack(a.props);t.startRenderSprite(a.props,o,a.maskState),a.updateSprites(n),t.endRenderSprite(r.removeFromStack())}break;case"mutTexture":e.updateTexture(),t.renderTexture(r.getTopStack(),e.texture,e.textureState,e.maskState);break;case"mutOnChange":n=n||e.updateOnChange();for(const i of e.containers)T(i,t,r,n);break;case"mutArrayTexture":e.updateTextureArray(),t.renderTexture(r.getTopStack(),e.texture,e.textureState,e.maskState);break;case"mutRun":e.updateRun();break;case"mutContext":for(const i of e.containers)T(i,t,r,n);break;case"native":e.updateSprite();break;default:!function(e){throw new Error("Replay unreachable error")}()}}function R(e,t,n,a,o,u,d,p,f,m,h){var g,y;if(null===e)return null;switch(e.type){case"text":case"circle":case"rectangle":case"image":case"line":case"spriteSheet":{const t=e.props,r=e.update;return null==r||r(t),{type:"mutTexture",texture:e,textureState:f.getInitTextureState(e),maskState:f.getInitMaskState(e.props.mask),updateTexture(){null==r||r(this.texture.props)},cleanup:()=>null}}case"rectangleArray":case"textArray":case"circleArray":case"lineArray":case"imageArray":{const t=e.array(),r=e.update;return e.props=Array.from({length:t.length}).map(((n,i)=>{const a=l(e,e.newProps(t[i],i));return null==r||r(a,t[i],i),a})),{type:"mutArrayTexture",texture:e,array:e.array,textureState:f.getInitTextureState(e),maskState:f.getInitMaskState(e.mask),cleanup:()=>null,pooledProps:[],updateTextureArray(){const t=this.array(),n=t.length,i=this.texture.props.length,a=n-i;if(a>0)for(let r=0;r<a;r++)if(this.pooledProps.length>0)this.texture.props.push(this.pooledProps.pop());else{const n=l(e,e.newProps(t[i+r],i+r));this.texture.props.push(n)}else if(a<0){let e=-a;for(;e>0;)e--,this.pooledProps.push(this.texture.props.pop())}for(let n=0;n<this.texture.props.length;n++){const i=this.texture.props[n];null==r||r(i,t[n],n),m&&e.testId&&(i.testId=e.testId(t[n],n))}}}}case"onChange":{const r=e.value();return{type:"mutOnChange",value:r,containers:e.sprites().map(((e,i)=>R(e,t,n,a,o,u,`${d}--${r}-${i}`,p,f,m,h))).filter(k),updateOnChange(){const r=e.value();return this.value!==r&&(this.value=r,this.cleanup(),this.containers=e.sprites().map(((e,i)=>R(e,t,n,a,o,u,`${d}--${r}-${i}`,p,f,m,h))).filter(k),!0)},cleanup(){for(const e of this.containers)e.cleanup()}}}case"run":return{type:"mutRun",updateRun:()=>{e.fn()},cleanup:()=>null};case"conditional":{const r=e.condition();return{type:"mutOnChange",value:r,containers:(r?e.trueSprites():e.falseSprites()).map(((e,i)=>R(e,t,n,a,o,u,`${d}--${r}-${i}`,p,f,m,h))).filter(k),updateOnChange(){const r=e.condition();return!this.value&&r?(this.value=!0,this.cleanup(),this.containers=e.trueSprites().map(((e,r)=>R(e,t,n,a,o,u,`${d}--true-${r}`,p,f,m,h))).filter(k),!0):!(!this.value||r||(this.value=!1,this.cleanup(),this.containers=e.falseSprites().map(((e,r)=>R(e,t,n,a,o,u,`${d}--false-${r}`,p,f,m,h))).filter(k),0))},cleanup(){for(const e of this.containers)e.cleanup()}}}case"mutContext":{const r=[...p,e];return{type:"mutContext",containers:e.sprites.map(((e,i)=>R(e,t,n,a,o,u,`${d}--${i}`,r,f,m,h))).filter(k),cleanup(){for(const e of this.containers)e.cleanup()}}}case"native":{const{nativeSpriteMap:t,nativeSpriteUtils:r}=h,i=t[e.name];if(!i)throw Error(`Cannot find Native Sprite "${e.name}"`);const a=i.create({props:e.props,parentGlobalId:d,getState:()=>s.state,utils:r}),o={props:e.props,state:a,parentGlobalId:d,utils:r,spriteToGameCoords:(e,t,r)=>{const i=c.multiplyPooled(n.getTopStack().transformationGameCoords,c.getTranslateMatrixPooled(e,t));r.x=i[4],r.y=i[5]}},s={type:"native",props:e.props,state:a,updateSprite(){var t;f.startNativeSprite(),null===(t=e.update)||void 0===t||t.call(e,this.props),i.loop(o),f.endNativeSprite()},cleanup:()=>{i.cleanup({state:s.state,parentGlobalId:d})}};return s}case"mutableArray":{const{spriteObj:r}=e,i=e.update,l=(t,n)=>{var i,a;const o=e.props(t,n);return s(o,o),null===(i=e.update)||void 0===i||i.call(e,o,t,n),null===(a=e.updateAll)||void 0===a||a.call(e,o),{type:"mutable",spriteObj:r,props:o}},c=[];return{type:"mutableArray",props:e.props,update:e.update,filter:e.filter,array:e.array,key:e.key,prevIdsA:c,prevIdsB:c,isOnSamePrevIdRef:!0,onPrevIdA:!0,containersArray:e.array().map(((t,r)=>void 0===e.filter||e.filter(t,r)?t:null)).reduce(((r,i,s)=>{if(null===i)return r;const c=e.key(i,s);return r[c]=R(l(i,s),t,n,a,o,u,`${d}--${c}`,p,f,m,h),r}),{}),updateSprites(){var r,s;const c=this.array(),g=this.onPrevIdA?this.prevIdsA:this.prevIdsB,y=this.onPrevIdA?this.prevIdsB:this.prevIdsA;let v=0,x=0;for(let y=0;y<c.length;y++){const A=c[y];if(!1===(null===(r=this.filter)||void 0===r?void 0:r.call(this,A,y)))continue;const _=e.key(A,y);g[v]=_,v++;let b=this.containersArray[_];b||(x++,b=R(l(A,y),t,n,a,o,u,`${d}--${_}`,p,f,m,h),this.containersArray[_]=b),null===(s=e.updateAll)||void 0===s||s.call(e,b.props),null==i||i(b.props,c[y],y)}v<g.length&&(g.length=v);const A=g.length,_=y.length+x;if(A>_){const e=g.find(((e,t)=>g.indexOf(e)!==t));throw Error(`Duplicate key ${e}`)}if(A<_){const e=new Set(y);for(const t of g)e.delete(t);for(const t of e)this.containersArray[t].cleanup(),delete this.containersArray[t]}this.onPrevIdA=!this.onPrevIdA,this.isOnSamePrevIdRef&&(this.isOnSamePrevIdRef=!1,this.prevIdsB=[...this.prevIdsB])},cleanup(){for(const e in this.containersArray)this.containersArray[e].cleanup()}}}case"mutable":{const{spriteObj:l}=e;let c=null;function v(e){const t=p.find((t=>t.context===e));if(!t)throw Error("No context setup");return t.value()}const{props:x}=e;s(x,x),null===(g=e.update)||void 0===g||g.call(e,x);let A=null;const _=null===(y=l.init)||void 0===y?void 0:y.call(l,{props:x,device:t,getState:()=>{if(!A)throw Error("Cannot call getState synchronously in init");return A.state},getInputs:()=>a(n.getStack((null==A?void 0:A.stackIndex)||0).transformationGameCoords,(null==A?void 0:A.inputs)||o()),getContext:v,preloadFiles:async e=>{const n=r(d,e,t.assetUtils);A?A.loadFilesPromise=n:c=n,await n}}),b={props:x,state:_,device:t,getInputs:()=>a(n.getStack((null==A?void 0:A.stackIndex)||0).transformationGameCoords,(null==A?void 0:A.inputs)||o()),getContext:v};return A={type:"mutable",props:x,state:_,inputs:o(),stackIndex:null,maskState:f.getInitMaskState(e.props.mask),childContainers:l.render({props:x,state:_,device:t,getInputs:()=>a(n.getStack((null==A?void 0:A.stackIndex)||0).transformationGameCoords,(null==A?void 0:A.inputs)||o()),getContext:v}).map(((e,r)=>R(e,t,n,a,o,u,`${d}--${r}`,p,f,m,h))).filter(k),updateSelf(){var t;null===(t=e.update)||void 0===t||t.call(e,x)},updateSprites(e){var t;null===this.stackIndex&&(this.stackIndex=n.getStackIndex()),e||null===(t=l.loop)||void 0===t||t.call(l,b);for(const t of this.childContainers)T(t,f,n,e)},cleanup(){var e;for(const e of this.childContainers)e.cleanup();null===(e=l.cleanup)||void 0===e||e.call(l,{state:this.state,device:t}),this.loadFilesPromise&&this.loadFilesPromise.then((()=>{i(d,t.assetUtils)}))},loadFilesPromise:c},A}}}function P(e){const{spriteObj:t}=e;return{type:"pure",childContainers:{},prevChildIds:[],prevChildIdsSet:new Set,baseProps:o(e.props),getSprites(e,r,n,i){if(this.prevProps&&this.cache&&!t.shouldRerender(this.prevProps,e)&&!n)return this.prevProps=e,this.cache;let a=t[i];return a||(a="renderPXL"===i&&t.renderXL?t.renderXL:t.render),this.prevProps=e,{type:"pureSprites",sprites:a({props:e,size:r})}},cleanup:()=>null}}function F(e,t,r,n,i,a,o){const{baseProps:l}=e;s(l,t);const c=e.getSprites(t,n,i,a);return"cache"===c.type?(I(c,o,r),c):function(e,t,r,n,i,a,o){const{baseProps:s}=e,l=e.prevChildIdsSet,c=e.prevChildIds;let u=0;o.startRenderSprite(s,r.addToStack(s),null);const d=new Array(t.length);let p=0;for(let s=0;s<t.length;s++){const f=t[s];if(f)if("pure"===f.type){c[u]=f.props.id,u++,l.delete(f.props.id);let t=e.childContainers[f.props.id];t&&"pure"===t.type||(t=P(f),e.childContainers[f.props.id]=t),d[p]=F(t,f.props,r,n,i,a,o),p++}else o.renderTexture(r.getTopStack(),f,o.getInitTextureState(f),null),d[p]=f,p++}p<d.length&&(d.length=p),o.endRenderSprite(r.removeFromStack());for(const t of l)delete e.childContainers[t];const f={type:"cache",baseProps:s,items:d};if(e.cache=f,u<c.length&&(c.length=u),e.prevChildIdsSet=new Set(c),e.prevChildIdsSet.size<c.length){const e=c.find(((e,t)=>c.indexOf(e)!==t));throw Error(`Duplicate Sprite id ${e}`)}return f}(e,c.sprites,r,n,i,a,o)}function I(e,t,r){const n=r.addToStack(e.baseProps);t.startRenderSprite(e.baseProps,n,null);for(let i=0;i<e.items.length;i++){const a=e.items[i];"cache"===a.type?I(a,t,r):t.renderTexture(n,a,t.getInitTextureState(a),null)}t.endRenderSprite(r.removeFromStack())}function k(e){return null!=e}const L={keysDown:{},keysJustPressed:{},pointer:{pressed:!1,numberPressed:0,justPressed:!1,justReleased:!1,x:0,y:0}};let M=[];const C=[1,0,0,1,0,0];function U(e,t){t.keysDown=L.keysDown,t.keysJustPressed=L.keysJustPressed,t.pointer.pressed=L.pointer.pressed,t.pointer.numberPressed=L.pointer.numberPressed,t.pointer.justPressed=L.pointer.justPressed,t.pointer.justReleased=L.pointer.justReleased;const r=c.invertPooled(e);if(!r)return t;C[4]=L.pointer.x,C[5]=L.pointer.y;const n=c.multiplyPooled(r,C);return t.pointer.x=n[4],t.pointer.y=n[5],t}function D(){return{keysDown:{},keysJustPressed:{},pointer:{pressed:!1,numberPressed:0,justPressed:!1,justReleased:!1,x:0,y:0}}}function N(e){["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "].includes(e.key)&&!(e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLInputElement)&&e.preventDefault(),L.keysDown[e.key]=!0,L.keysJustPressed[e.key]=!0}function B(e){L.keysDown[e.key]=void 0}function O(e,t,r){M.includes(r)||(M=[...M,r]),L.pointer.pressed=!0,L.pointer.numberPressed=M.length,L.pointer.justPressed=!0,L.pointer.x=e,L.pointer.y=t}function Y(e,t){L.pointer.x=e,L.pointer.y=t}function V(e,t,r){M=M.filter((e=>e!==r)),0===M.length&&(L.pointer.justPressed=!1,L.pointer.pressed=!1),L.pointer.numberPressed=M.length,L.pointer.justReleased=!0,L.pointer.x=e,L.pointer.y=t}function X(e){M=M.filter((t=>t!==e)),L.pointer.numberPressed=M.length,0===M.length&&(L.pointer.justPressed=!1,L.pointer.pressed=!1)}function G(){for(const e in L.keysJustPressed)L.keysJustPressed[e]=void 0;L.pointer.justPressed=!1,L.pointer.justReleased=!1}function z(e,t,r,n){let i;i="portrait"in n?t>e?n.portrait:n.landscape:n;const{width:a,height:o,maxWidthMargin:s=0,maxHeightMargin:l=0}=i;if("game-coords"===r||0===e||0===t)return{width:a,height:o,widthMargin:0,heightMargin:0,fullWidth:a,fullHeight:o,deviceWidth:a,deviceHeight:o};const c=a/o;if(c>e/t){const r=e,n=r/c,i=n/o*l,s=Math.min(t,n+2*i),u=(s-n)/2*(o/n);return{width:a,height:o,widthMargin:0,heightMargin:u,fullWidth:a,fullHeight:o+2*u,deviceWidth:r,deviceHeight:s}}{const r=t,n=r*c,i=n/a*s,l=Math.min(e,n+2*i),u=(l-n)/2*(a/n);return{width:a,height:o,widthMargin:u,heightMargin:0,fullWidth:a+2*u,fullHeight:o,deviceWidth:l,deviceHeight:r}}}function $(){const e={};return{start:(t,r)=>{const n=window.setTimeout((()=>{delete e[i],t()}),r),i=String(n);return e[i]={timeoutId:n,callback:t,timeStartedMs:Date.now(),timeRemainingMs:r,isPaused:!1},i},pause:t=>{const r=e[t];if(!r||r.isPaused)return;const n=Date.now()-r.timeStartedMs;r.timeRemainingMs-=n,r.isPaused=!0,window.clearTimeout(r.timeoutId)},resume:t=>{const r=e[t];if(!r||!r.isPaused)return;r.timeStartedMs=Date.now(),r.isPaused=!1;const n=window.setTimeout((()=>{delete e[t],r.callback()}),r.timeRemainingMs);r.timeoutId=n},cancel:t=>{const r=e[t];r&&(window.clearTimeout(r.timeoutId),delete e[t])}}}function W(e,t){return r=>{if(!t[r])throw Error(`Audio file "${r}" was not preloaded`);const{data:n}=t[r];if("then"in n)throw Error(`Audio file "${r}" did not finish loading before it was used`);const{buffer:i,playState:a}=n;return{getPosition:()=>j(e,n.playState),play:o=>{let s,l=!1,c=!1,u=1;"number"==typeof o?s=o:o&&({fromPosition:s,loop:l=l,overwrite:c=c,playbackRate:u=u}=o);const d=e.createBufferSource();d.buffer=i,d.playbackRate.value=u;const p=e.createGain();d.connect(p),p.connect(e.destination);const f=null!=s?s:j(e,a);try{d.start(void 0,f)}catch(e){return}d.loop=l,d.onended=()=>{var e;if(!t[r])return;const{data:n}=t[r];"then"in n||!1!==(null===(e=n.playState)||void 0===e?void 0:e.isPaused)||delete n.playState};const m=a&&!a.isPaused;m&&!c||(a&&m&&(a.sample.onended=null,a.sample.stop()),n.playState={playTime:e.currentTime,sample:d,alreadyPlayedTime:f,isPaused:!1,gainNode:p})},pause:()=>{a&&!a.isPaused&&(a.sample.onended=null,a.sample.stop(),n.playState={...a,alreadyPlayedTime:j(e,a),isPaused:!0})},getStatus:()=>n.playState&&!1===n.playState.isPaused?"playing":"paused",getDuration:()=>i.duration,getVolume:()=>n.playState?n.playState.gainNode.gain.value:1,setVolume:t=>{const r=n.playState;if(r)if("number"==typeof t)r.gainNode.gain.setValueAtTime(Math.max(Math.min(1,t),0),e.currentTime);else{const{type:n,fadeTo:i,fadeTime:a}=t,o=Math.max(Math.min(1,i),0);"linear"===n?r.gainNode.gain.linearRampToValueAtTime(o,e.currentTime+a):r.gainNode.gain.exponentialRampToValueAtTime(o,e.currentTime+a)}}}}}function j(e,t){return t?t.isPaused?t.alreadyPlayedTime:(e.currentTime-t.playTime)*t.sample.playbackRate.value+t.alreadyPlayedTime:0}const H="__replay_resolution_v1__";function J(e,t,r){const n=K(e,e.VERTEX_SHADER,t),i=K(e,e.FRAGMENT_SHADER,r),a=e.createProgram();if(e.attachShader(a,n),e.attachShader(a,i),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS))return a;throw Error(e.getProgramInfoLog(a)||"")}function K(e,t,r){const n=e.createShader(t);if(e.shaderSource(n,r),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS))return n;throw Error(e.getShaderInfoLog(n)||"")}const q={black:"#000000",silver:"#c0c0c0",gray:"#808080",white:"#ffffff",maroon:"#800000",red:"#ff0000",purple:"#800080",fuchsia:"#ff00ff",green:"#008000",lime:"#00ff00",olive:"#808000",yellow:"#ffff00",navy:"#000080",blue:"#0000ff",teal:"#008080",aqua:"#00ffff"},Q={r:0,g:0,b:0};function Z(e,t){e.startsWith("#")||(e=q[e]||q.black);const r=Number.parseInt(e.slice(1),16),n=r>>16,i=r>>8&255,a=255&r;return void 0!==t?(Q.r=t*(n/255),Q.g=t*(i/255),Q.b=t*(a/255)):(Q.r=n/255,Q.g=i/255,Q.b=a/255),Q}function ee(e,t,r,n,i,a,o,s){const l=t.colors.length;e.uniform1i(r,0),e.uniform1f(n,l),"linearHoriz"===t.type?(e.uniform1f(i,t.width/o),e.uniform1i(a,1)):(e.uniform1f(i,t.height/s),e.uniform1i(a,0))}function te(e,t){const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);const n=t.colors.length;return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,n,1,0,e.RGBA,e.UNSIGNED_BYTE,function(e){const t=Array.from({length:4*e.colors.length});for(let r=0;r<e.colors.length;r++){const n=e.colors[r],{r:i,g:a,b:o}=Z(n);let s=1;if(e.opacities){const t=e.opacities[r];void 0!==t&&(s=t)}const l=4*r;t[l]=255*i,t[l+1]=255*a,t[l+2]=255*o,t[l+3]=255*s}return new Uint8Array(t)}(t)),r}function re(e,t){const r=e.createTexture();return e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),r}const ne=(e,t)=>{const r="linearHoriz"===t.type?e.createLinearGradient(-t.width/2,0,t.width/2,0):e.createLinearGradient(0,-t.height/2,0,t.height/2);for(let e=0;e<t.colors.length;e++){let n=t.colors[e];if(t.opacities){const r=t.opacities[e];if(void 0!==r){const{r:e,g:t,b:i}=Z(n);n=`rgba(${255*e}, ${255*t}, ${255*i}, ${r}`}}const i=e/(t.colors.length-1);r.addColorStop(i,n)}return r};function ie(e,t,r,n,i,a,o,s,l,u){const d=e.canvas.width,p=e.canvas.height,f=d*u/i;e.viewport(0,0,d,p);const m=n.getContext("2d"),h={texture:null,program:null},y=function(e,t,r){const n=J(e,"\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat3 u_matrix;\nuniform mat3 u_texture_matrix;\n\nvarying vec2 v_texcoord;\n\nconst mat3 flipY = mat3(\n  1.0, 0.0, 0.0,\n  0.0, -1.0, 0.0,\n  0.0, 1.0, 1.0\n);\n\nvoid main() {\n  gl_Position = vec4(u_matrix * vec3(a_position, 1.0), 1.0);\n  v_texcoord = (flipY * u_texture_matrix * vec3(a_texcoord, 1.0)).xy;\n}","\nprecision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D u_texture;\nuniform float u_opacity;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texcoord) * u_opacity;\n}\n"),i=t.createVertexArrayOES();t.bindVertexArrayOES(i);const a=e.getAttribLocation(n,"a_position"),o=e.getAttribLocation(n,"a_texcoord"),s=e.getUniformLocation(n,"u_matrix"),l=e.getUniformLocation(n,"u_texture_matrix"),u=e.getUniformLocation(n,"u_texture"),d=e.getUniformLocation(n,"u_opacity"),p=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,p),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),e.STATIC_DRAW);const f=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),t.bindVertexArrayOES(null);const m=c.getNewIdentity3fv(),h=c.getNewIdentity3fv();return function(a,o,p,f,g,y){a!==r.texture&&(e.bindTexture(e.TEXTURE_2D,a),r.texture=a),n!==r.program&&(e.useProgram(n),r.program=n,t.bindVertexArrayOES(i)),c.scaleToUniform3fvMut(o,p,f,m),e.uniformMatrix3fv(s,!1,m),function(e,t){if(!e)return void c.toUniform3fvMut(c.identityMatrix,t);const{columns:r,rows:n,index:i}=e,a=i%r,o=Math.floor(i/r)%n,s=c.multiplyPooled(c.getTranslateMatrixPooled(a/r,(n-1-o)/n),c.getScaleMatrixPooled(1/r,1/n));c.toUniform3fvMut(s,t)}(y,h),e.uniformMatrix3fv(l,!1,h),e.uniform1i(u,0),e.uniform1f(d,g),e.drawArrays(e.TRIANGLES,0,6)}}(e,r,h),x=function(e,t,r,n){const i=J(e,"\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\nattribute vec4 a_matrix_abcd;\nattribute vec2 a_matrix_txty;\nattribute float a_opacity;\n\nvarying vec2 v_texcoord;\nvarying float v_opacity;\n\nconst mat3 flipY = mat3(\n  1.0, 0.0, 0.0,\n  0.0, -1.0, 0.0,\n  0.0, 1.0, 1.0\n);\n\nvoid main() {\n  mat3 matrix = mat3(\n    a_matrix_abcd.x, a_matrix_abcd.y, 0,\n    a_matrix_abcd.z, a_matrix_abcd.w, 0,\n    a_matrix_txty.x, a_matrix_txty.y, 1\n  );\n  gl_Position = vec4(matrix * vec3(a_position, 1.0), 1.0);\n  v_texcoord = (flipY * vec3(a_texcoord, 1.0)).xy;\n  v_opacity = a_opacity;\n}","\nprecision mediump float;\n\nvarying vec2 v_texcoord;\nvarying float v_opacity;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texcoord) * v_opacity;\n}\n"),a=r.createVertexArrayOES();r.bindVertexArrayOES(a);const o=e.getAttribLocation(i,"a_position"),s=e.getAttribLocation(i,"a_texcoord"),l=e.getAttribLocation(i,"a_matrix_abcd"),c=e.getAttribLocation(i,"a_matrix_txty"),u=e.getAttribLocation(i,"a_opacity"),d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),e.STATIC_DRAW);const p=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,p),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW);const f=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f),e.enableVertexAttribArray(l),e.vertexAttribPointer(l,4,e.FLOAT,!1,24,0),t.vertexAttribDivisorANGLE(l,1),e.enableVertexAttribArray(c),e.vertexAttribPointer(c,2,e.FLOAT,!1,24,16),t.vertexAttribDivisorANGLE(c,1);const m=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,m),e.enableVertexAttribArray(u),e.vertexAttribPointer(u,1,e.FLOAT,!1,0,0),t.vertexAttribDivisorANGLE(u,1),r.bindVertexArrayOES(null),function(o,s,l,c,u){o!==n.texture&&(e.bindTexture(e.TEXTURE_2D,o),n.texture=o),i!==n.program&&(e.useProgram(i),n.program=i,r.bindVertexArrayOES(a)),function(e,t,r,n){const i=6*t.length;e.matrices.length!==i&&(e.matrices=new Float32Array(i));const a=e.matrices,o=t.length;e.opacities.length!==o&&(e.opacities=new Float32Array(o));const s=e.opacities;for(let e=0;e<t.length;e++){const i=t[e],o=v(r,i,i.width,i.height),l=6*e;a[l]=o[0],a[l+1]=o[1],a[l+2]=o[2],a[l+3]=o[3],a[l+4]=o[4],a[l+5]=o[5],s[e]=i.show?i.opacity*n:0}}(s,u,l,c),e.bindBuffer(e.ARRAY_BUFFER,f),e.bufferData(e.ARRAY_BUFFER,s.matrices,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,m),e.bufferData(e.ARRAY_BUFFER,s.opacities,e.DYNAMIC_DRAW),t.drawArraysInstancedANGLE(e.TRIANGLES,0,6,u.length)}}(e,t,r,h),A=function(e,t,r){const n=J(e,"\nattribute vec2 a_position;\n\nuniform mat3 u_matrix;\n\nvoid main() {\n  gl_Position = vec4(u_matrix * vec3(a_position, 1.0), 1.0);\n}\n","\nprecision mediump float;\n\nuniform vec4 u_colour;\n\nvoid main() {\n  gl_FragColor = u_colour;\n}\n"),i=t.createVertexArrayOES();t.bindVertexArrayOES(i);const a=e.getAttribLocation(n,"a_position"),o=e.getUniformLocation(n,"u_matrix"),s=e.getUniformLocation(n,"u_colour"),l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),e.STATIC_DRAW),t.bindVertexArrayOES(null);const u=c.getNewIdentity3fv();return function(a,l,d,p,f){n!==r.program&&(e.useProgram(n),r.program=n,t.bindVertexArrayOES(i));const m=c.multiplyPooled(a,c.getScaleMatrixPooled(d,p));c.toUniform3fvMut(m,u),e.uniformMatrix3fv(o,!1,u);const{r:h,g,b:y}=Z(l,f);e.uniform4f(s,h,g,y,f),e.drawArrays(e.TRIANGLES,0,6)}}(e,r,h),_=function(e,t,r,n){const i=J(e,"\nattribute vec2 a_position;\nattribute vec4 a_matrix_abcd;\nattribute vec2 a_matrix_txty;\nattribute vec4 a_colour;\n\nvarying vec4 v_colour;\n\nvoid main() {\n  mat3 matrix = mat3(\n    a_matrix_abcd.x, a_matrix_abcd.y, 0,\n    a_matrix_abcd.z, a_matrix_abcd.w, 0,\n    a_matrix_txty.x, a_matrix_txty.y, 1\n  );\n  gl_Position = vec4(matrix * vec3(a_position, 1.0), 1.0);\n  v_colour = a_colour;\n}\n","\nprecision mediump float;\n\nvarying vec4 v_colour;\n\nvoid main() {\n  gl_FragColor = v_colour;\n}\n"),a=r.createVertexArrayOES();r.bindVertexArrayOES(a);const o=e.getAttribLocation(i,"a_position"),s=e.getAttribLocation(i,"a_matrix_abcd"),l=e.getAttribLocation(i,"a_matrix_txty"),c=e.getAttribLocation(i,"a_colour"),u=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,u),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),e.STATIC_DRAW);const d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,4,e.FLOAT,!1,24,0),t.vertexAttribDivisorANGLE(s,1),e.enableVertexAttribArray(l),e.vertexAttribPointer(l,2,e.FLOAT,!1,24,16),t.vertexAttribDivisorANGLE(l,1);const p=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,p),e.enableVertexAttribArray(c),e.vertexAttribPointer(c,4,e.FLOAT,!1,0,0),t.vertexAttribDivisorANGLE(c,1),r.bindVertexArrayOES(null),function(o,s,l,c){i!==n.program&&(e.useProgram(i),n.program=i,r.bindVertexArrayOES(a)),function(e,t,r,n){const i=6*n.length;e.matrices.length!==i&&(e.matrices=new Float32Array(i));const a=e.matrices,o=4*n.length;e.colours.length!==o&&(e.colours=new Float32Array(o));const s=e.colours;for(let e=0;e<n.length;e++){const i=n[e],o=v(t,i,i.width,i.height),l=6*e;a[l]=o[0],a[l+1]=o[1],a[l+2]=o[2],a[l+3]=o[3],a[l+4]=o[4],a[l+5]=o[5];const c=i.show?r*i.opacity:0,{r:u,g:d,b:p}=Z(i.color,c),f=4*e;s[f]=u,s[f+1]=d,s[f+2]=p,s[f+3]=c}}(s,o,l,c),e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,s.matrices,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,p),e.bufferData(e.ARRAY_BUFFER,s.colours,e.DYNAMIC_DRAW),t.drawArraysInstancedANGLE(e.TRIANGLES,0,6,c.length)}}(e,t,r,h),b=function(e,t,r){const n=J(e,"\nattribute vec2 a_point;\n\nuniform mat3 u_matrix;\nuniform bool u_horizontal;\nuniform float u_ramp_width;\nuniform float u_gradient_length;\n\nvarying float ramp_distance;\n\nvoid main() {\n  float grad_coord = 0.0;\n\n  if (u_horizontal) {\n    grad_coord = a_point.x;\n  } else {\n    grad_coord = -a_point.y;\n  }\n\n  // grad_coord = -0.5 / 0.5 is edges of rect\n  // mixValue varies from 0 -> 1 along gradient length\n  float mixValue = 0.5 + grad_coord / u_gradient_length;\n\n  float rampPixelLength = 1.0 / u_ramp_width;\n\n  ramp_distance =\n    // Left offset to middle of pixel\n    rampPixelLength / 2.0 +\n    // Distance along ramp width\n    mixValue * (1.0 - rampPixelLength);\n\n  gl_Position = vec4(u_matrix * vec3(a_point, 1.0), 1.0);\n}\n","\nprecision mediump float;\n\nuniform sampler2D u_ramp_texture;\nuniform float u_opacity;\n\nvarying float ramp_distance;\n\nvoid main() {\n  gl_FragColor = texture2D(\n    u_ramp_texture,\n    vec2(ramp_distance, 0.5)\n  ) * u_opacity;\n}\n"),i=t.createVertexArrayOES();t.bindVertexArrayOES(i);const a=e.getAttribLocation(n,"a_point"),o=e.getUniformLocation(n,"u_matrix"),s=e.getUniformLocation(n,"u_ramp_texture"),l=e.getUniformLocation(n,"u_ramp_width"),u=e.getUniformLocation(n,"u_gradient_length"),d=e.getUniformLocation(n,"u_horizontal"),p=e.getUniformLocation(n,"u_opacity"),f=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),e.STATIC_DRAW),t.bindVertexArrayOES(null);const m=c.getNewIdentity3fv();return function(a,f,h,g,y,v){f!==r.texture&&(e.bindTexture(e.TEXTURE_2D,f),r.texture=f),n!==r.program&&(e.useProgram(n),r.program=n,t.bindVertexArrayOES(i));const x=c.multiplyPooled(a,c.getScaleMatrixPooled(g,y));c.toUniform3fvMut(x,m),e.uniformMatrix3fv(o,!1,m),e.uniform1f(p,v),ee(e,h,s,l,u,d,g,y),e.drawArrays(e.TRIANGLES,0,6)}}(e,r,h),S=function(e,t,r){const n=J(e,"\nattribute vec2 a_origin;\nattribute vec2 a_point1;\nattribute vec2 a_point2;\n\nuniform mat3 u_matrix;\nuniform float u_half_thickness;\n\nvoid main() {\n  if (a_point1 == a_point2) {\n    // Avoid normalize a zero vector\n    gl_Position = vec4(u_matrix * vec3(a_origin, 1.0), 1.0);\n    return;\n  }\n\n  vec2 normal = normalize(a_point2 - a_point1);\n  vec2 tangent = vec2(-normal.y, normal.x);\n  vec2 pos = a_origin + tangent * u_half_thickness;\n\n  gl_Position = vec4(u_matrix * vec3(pos, 1.0), 1.0);\n}\n","\nprecision mediump float;\n\nuniform vec4 u_colour;\n\nvoid main() {\n  gl_FragColor = u_colour;\n}\n"),i=t.createVertexArrayOES(),a=t.createVertexArrayOES(),o=e.getAttribLocation(n,"a_point1"),s=e.getAttribLocation(n,"a_point2"),l=e.getAttribLocation(n,"a_origin"),u=e.getUniformLocation(n,"u_matrix"),d=e.getUniformLocation(n,"u_half_thickness"),p=e.getUniformLocation(n,"u_colour"),f=e.createBuffer();t.bindVertexArrayOES(i),e.bindBuffer(e.ARRAY_BUFFER,f),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,24,8),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,24,16),e.enableVertexAttribArray(l),e.vertexAttribPointer(l,2,e.FLOAT,!1,24,0),t.bindVertexArrayOES(a),e.bindBuffer(e.ARRAY_BUFFER,f),e.enableVertexAttribArray(l),e.vertexAttribPointer(l,2,e.FLOAT,!1,96,0),e.disableVertexAttribArray(o),e.disableVertexAttribArray(s),t.bindVertexArrayOES(null);const m=c.getNewIdentity3fv();return function(o,s,l,h,g,y,v,x){if(l.length<=1)s.lineCaps=null;else{if(n!==r.program&&(e.useProgram(n),r.program=n,e.bindBuffer(e.ARRAY_BUFFER,f)),function(e,t){const r=24*t.length;e.strokePath.length!==r&&(e.strokePath=new Float32Array(r));const n=e.strokePath;let i,a,o,s,l=t[0][0],c=t[0][1];for(let e=0;e<t.length;e++){const r=24*e;i=o,a=s,o=l,s=c;const u=t[e+1];u?[l,c]=u:(l=o,c=s),void 0!==i&&void 0!==a||(i=o,a=s),n[r]=o,n[r+1]=s,n[r+2]=i,n[r+3]=a,n[r+4]=o,n[r+5]=s,n[r+6]=o,n[r+7]=s,n[r+8]=o,n[r+9]=s,n[r+10]=i,n[r+11]=a,n[r+12]=o,n[r+13]=s,n[r+14]=o,n[r+15]=s,n[r+16]=l,n[r+17]=c,n[r+18]=o,n[r+19]=s,n[r+20]=l,n[r+21]=c,n[r+22]=o,n[r+23]=s}}(s,l),e.bufferData(e.ARRAY_BUFFER,s.strokePath,e.DYNAMIC_DRAW),c.toUniform3fvMut(o,m),e.uniformMatrix3fv(u,!1,m),e.uniform1f(d,h/2),y){const{r,g:n,b:i}=Z(y,x);e.uniform4f(p,r,n,i,x),t.bindVertexArrayOES(a),e.drawArrays(e.TRIANGLE_FAN,0,l.length)}if(g){const{r,g:n,b:a}=Z(g,x);e.uniform4f(p,r,n,a,x),t.bindVertexArrayOES(i),e.drawArrays(e.TRIANGLE_STRIP,0,4*l.length),"round"===v?function(e,t){const r=e[0],n=e[1],i=e[e.length-2],a=e[e.length-1];t.lineCaps||(t.lineCaps=[{x:0,y:0,angleRad:0,textureState:{points:new Float32Array}},{x:0,y:0,angleRad:0,textureState:{points:new Float32Array}}]),t.lineCaps[0].x=r[0],t.lineCaps[0].y=r[1],t.lineCaps[0].angleRad=Math.atan2(n[1]-r[1],n[0]-r[0])+Math.PI/2,t.lineCaps[1].x=a[0],t.lineCaps[1].y=a[1],t.lineCaps[1].angleRad=Math.atan2(a[1]-i[1],a[0]-i[0])-Math.PI/2}(l,s):s.lineCaps=null}else s.lineCaps=null}}}(e,r,h),E=function(e,t,r){const n=J(e,"\nattribute vec2 a_point;\n\nuniform mat3 u_matrix;\nuniform bool u_horizontal;\nuniform float u_ramp_width;\nuniform float u_gradient_length;\n\nvarying float ramp_distance;\n\nvoid main() {\n  float grad_coord = 0.0;\n\n  if (u_horizontal) {\n    grad_coord = a_point.x;\n  } else {\n    grad_coord = -a_point.y;\n  }\n\n  // mixValue varies from 0 -> 1 along gradient length\n  float mixValue = 0.5 + grad_coord / u_gradient_length;\n\n  float rampPixelLength = 1.0 / u_ramp_width;\n\n  ramp_distance =\n    // Left offset to middle of pixel\n    rampPixelLength / 2.0 +\n    // Distance along ramp width\n    mixValue * (1.0 - rampPixelLength);\n\n  gl_Position = vec4(u_matrix * vec3(a_point, 1.0), 1.0);\n}\n","\nprecision mediump float;\n\nuniform sampler2D u_ramp_texture;\nuniform float u_opacity;\n\nvarying float ramp_distance;\n\nvoid main() {\n  gl_FragColor = texture2D(\n    u_ramp_texture,\n    vec2(ramp_distance, 0.5)\n  ) * u_opacity;\n}\n"),i=t.createVertexArrayOES();t.bindVertexArrayOES(i);const a=e.getAttribLocation(n,"a_point"),o=e.getUniformLocation(n,"u_matrix"),s=e.getUniformLocation(n,"u_ramp_texture"),l=e.getUniformLocation(n,"u_ramp_width"),u=e.getUniformLocation(n,"u_gradient_length"),d=e.getUniformLocation(n,"u_horizontal"),p=e.getUniformLocation(n,"u_opacity"),f=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),t.bindVertexArrayOES(null);const m=c.getNewIdentity3fv();return function(a,h,g,y,v,x){y.length<=1||(g!==r.texture&&(e.bindTexture(e.TEXTURE_2D,g),r.texture=g),n!==r.program&&(e.useProgram(n),r.program=n,t.bindVertexArrayOES(i),e.bindBuffer(e.ARRAY_BUFFER,f)),function(e,t){const r=2*e.length;t.linePath.length!==r&&(t.linePath=new Float32Array(r));const n=t.linePath;for(let t=0;t<e.length;t++){const[r,i]=e[t],a=2*t;n[a]=r,n[a+1]=i}}(y,h),e.bufferData(e.ARRAY_BUFFER,h.linePath,e.DYNAMIC_DRAW),c.toUniform3fvMut(a,m),e.uniformMatrix3fv(o,!1,m),e.uniform1f(p,x),ee(e,v,s,l,u,d,1,1),e.drawArrays(e.TRIANGLE_FAN,0,y.length))}}(e,r,h),w=function(e,t,r){const n=J(e,"\n#define PI 3.1415926538\n\nattribute float a_vertex;\nuniform float u_num_vertex;\nuniform float u_radius;\nuniform float u_angle_multiplier;\n\nuniform mat3 u_matrix;\n\nvoid main() {\n  if (a_vertex < 0.0) {\n    // Origin\n    gl_Position = vec4(u_matrix * vec3(0.0, 0.0, 1.0), 1.0);\n    return;\n  }\n  float dr = a_vertex / u_num_vertex;\n  float angle = dr * PI * 2.0 * u_angle_multiplier;\n\n  vec2 position = vec2(cos(angle), sin(angle)) * u_radius;\n\n  gl_Position = vec4(u_matrix * vec3(position, 1.0), 1.0);\n}\n","\nprecision mediump float;\n\nuniform vec4 u_colour;\n\nvoid main() {\n  gl_FragColor = u_colour;\n}\n"),i=t.createVertexArrayOES();t.bindVertexArrayOES(i);const a=e.getAttribLocation(n,"a_vertex"),o=e.getUniformLocation(n,"u_num_vertex"),s=e.getUniformLocation(n,"u_radius"),l=e.getUniformLocation(n,"u_angle_multiplier"),u=e.getUniformLocation(n,"u_matrix"),d=e.getUniformLocation(n,"u_colour"),p=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,p),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,1,e.FLOAT,!1,0,0),t.bindVertexArrayOES(null);const f=c.getNewIdentity3fv();return function(a,m,h,g,y,v,x,A,_){n!==r.program&&(e.useProgram(n),r.program=n,t.bindVertexArrayOES(i),e.bindBuffer(e.ARRAY_BUFFER,p));const{scaleX:b,scaleY:S}=c.getScalePooled(a),E=Math.max(b*y,S*v)/2,w=Math.ceil(Math.PI*g*E*x);!function(e,t){const r=t+2;if(e.points.length!==r){e.points=new Float32Array(r);for(let t=-1;t<r-1;t++)e.points[t]=t}}(m,w),e.bufferData(e.ARRAY_BUFFER,m.points,e.DYNAMIC_DRAW),c.toUniform3fvMut(a,f),e.uniformMatrix3fv(u,!1,f);const{r:T,g:R,b:P}=Z(h,A);e.uniform4f(d,T,R,P,A),e.uniform1f(o,w),e.uniform1f(s,g),e.uniform1f(l,_?.5:1),e.drawArrays(e.TRIANGLE_FAN,0,w+2)}}(e,r,h),T=function(e,t,r){const n=J(e,"\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat3 u_matrix;\n\nvarying vec2 v_texcoord;\n\nconst mat3 flipY = mat3(\n  1.0, 0.0, 0.0,\n  0.0, -1.0, 0.0,\n  0.0, 1.0, 1.0\n);\n\nvoid main() {\n  gl_Position = vec4(u_matrix * vec3(a_position, 1.0), 1.0);\n  v_texcoord = (flipY * vec3(a_texcoord, 1.0)).xy;\n}","\nprecision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D u_texture;\nuniform float u_opacity;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texcoord) * u_opacity;\n}\n"),i=t.createVertexArrayOES();t.bindVertexArrayOES(i);const a=e.getAttribLocation(n,"a_position"),o=e.getAttribLocation(n,"a_texcoord"),s=e.getUniformLocation(n,"u_matrix"),l=e.getUniformLocation(n,"u_texture"),u=e.getUniformLocation(n,"u_opacity"),d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),e.STATIC_DRAW);const p=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,p),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),t.bindVertexArrayOES(null);const f=c.getNewIdentity3fv();return function(a,o,d,p,m,h){e.bindTexture(e.TEXTURE_2D,a),r.texture=a,n!==r.program&&(e.useProgram(n),r.program=n,t.bindVertexArrayOES(i));const g=c.multiplyPooled(o,c.getScaleMatrixPooled(d/h,p/h));c.toUniform3fvMut(g,f),e.uniformMatrix3fv(s,!1,f),e.uniform1i(l,0),e.uniform1f(u,m),e.drawArrays(e.TRIANGLES,0,6)}}(e,r,h);function R(t,r,n,o,s){var l,d;if(!t)return;if(e.isEnabled(e.STENCIL_TEST))throw Error("Nested masks not supported");e.enable(e.STENCIL_TEST),e.clear(e.STENCIL_BUFFER_BIT),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE);const p=c.multiply(void 0===o||void 0===s||0===o&&0===s?n:c.multiply(n,c.getTranslateMatrix(o,s)),c.getTranslateMatrix(t.x,t.y));switch(e.colorMask(!1,!1,!1,!1),t.type){case"circleMask":null===r&&(r={value:null}),"circleMask"!==(null===(l=r.value)||void 0===l?void 0:l.type)&&(r.value={type:"circleMask",points:new Float32Array}),w(p,r.value,"",t.radius,i,a,u,1,!1);break;case"lineMask":null===r&&(r={value:null}),"lineMask"!==(null===(d=r.value)||void 0===d?void 0:d.type)&&(r.value={type:"lineMask",lineCaps:null,linePath:new Float32Array,strokePath:new Float32Array}),S(p,r.value,t.path,0,void 0," ","butt",1);break;case"rectangleMask":A(p,"",t.width,t.height,1)}e.colorMask(!0,!0,!0,!0),e.stencilFunc(e.EQUAL,1,255),e.stencilOp(e.KEEP,e.KEEP,e.KEEP)}function P(){e.disable(e.STENCIL_TEST)}const F={},I=new Set,k=[0,0,0,0,0,0],{r:L,g:M,b:C}=Z(l);function U(t,r,n){const o=t.fillGradient;if(o){const i=`${o.type}-${o.colors.join("")}-${(o.opacities||[]).join("")}`;let a=F[i];a?I.delete(i):(a={texture:te(e,o),width:0,height:0,align:"center"},F[i]=a),E(k,n,a.texture,t.path,o,t.opacity*r)}if(t.color||t.fillColor){S(k,n,t.path,t.thickness,t.color,t.fillColor,t.lineCap,t.opacity*r);const e=t.color;if(n.lineCaps&&e)for(const o of n.lineCaps){const n=c.multiplyPooled(c.getTranslateMatrixPooled(o.x,o.y),c.getRotateMatrixPooled(o.angleRad)),s=c.multiplyPooled(k,n);w(s,o.textureState,e,t.thickness/2,i,a,f,t.opacity*r,!0)}}}function D(t,r){const{text:i,color:a,strokeColor:o,font:l}=t,d=l?`${i}-${a}-${o}-${l.size}-${l.weight}-${l.style}-${l.align}`:`${i}-${a}-${o}`;let p=F[d];if(p)I.delete(d);else{const r=function(e,t,r,n,i){const a={...n,...e.font},{size:o=10,weight:s="normal",style:l="normal",family:c,align:u="center",baseline:d="middle"}=a,p=`${l} ${s} ${o?`${o}px`:""} ${c?`${c}`:""}`,{text:f,strokeThickness:m=1,color:h}=e;return function(e,t,r,n,i){const a=r*n,o=r*i;a!==e.width||o!==e.height?(e.width=a,e.height=o,t.translate(a/2,o/2),t.scale(r,r)):t.clearRect(-a/2,-o/2,e.width,e.height)}(t,r,i,function(e,t,r,n){return e.font=n,e.measureText(t).width+2*r}(r,f,m,p),1.5*o*("middle"!==d?2:1)),function(e,t,r,n,i,a,o,s,l){e.font=t,e.textBaseline=a,e.textAlign="center",l&&(e.strokeStyle=l,e.lineWidth=i,e.strokeText(r,0,0)),e.fillStyle=s?ne(e,s):n,e.fillText(r,0,0)}(r,p,f,h,m,d,0,e.gradient,e.strokeColor),u}(t,n,m,s,u);p={texture:re(e,n),width:n.width,height:n.height,align:r},F[d]=p}const{align:f,width:h,height:g}=p;T(p.texture,"center"===f?k:c.multiplyPooled(k,c.getTranslateMatrixPooled(h/(2*u)*("left"===f?1:-1),0)),h,g,t.opacity*r,u)}return{newFrame:()=>{e.clearColor(L,M,C,1),e.clear(e.COLOR_BUFFER_BIT);for(const t of I)e.deleteTexture(F[t].texture),delete F[t];I.clear();for(const e in F)I.add(e);e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)},endFrame:()=>{r.bindVertexArrayOES(null),h.program=null,h.texture=null},startRenderSprite:(e,t,r)=>{R(e.mask,r,t.transformation)},endRenderSprite:e=>{e.hasMask&&P()},renderTexture:(t,r,n,s)=>{if("imageArray"===r.type){if(0===r.props.length)return;const e=n;R(r.mask,s,t.transformation);const i=ae(o,r.fileName);return x(i.texture,e,t.transformation,t.opacity,r.props),void(r.mask&&P())}if("rectangleArray"===r.type){if(0===r.props.length)return;const e=n;return R(r.mask,s,t.transformation),_(t.transformation,e,t.opacity,r.props),void(r.mask&&P())}if("textArray"!==r.type)if("circleArray"!==r.type)if("lineArray"!==r.type){if(r.props.show){switch(g(t.transformation,k,r.props),R(r.props.mask,s,t.transformation,r.props.x,r.props.y),r.type){case"image":case"spriteSheet":{const e=ae(o,r.props.fileName);y(e.texture,k,r.props.width,r.props.height,r.props.opacity*t.opacity,"spriteSheet"===r.type?r.props:null);break}case"line":{const e=n;U(r.props,t.opacity,e);break}case"rectangle":{const n=r.props.gradient;if(n){const i=`${n.type}-${n.colors.join("")}-${(n.opacities||[]).join("")}`;let a=F[i];a?I.delete(i):(a={texture:te(e,n),width:0,height:0,align:"center"},F[i]=a),b(k,a.texture,n,r.props.width,r.props.height,r.props.opacity*t.opacity)}else A(k,r.props.color,r.props.width,r.props.height,r.props.opacity*t.opacity);break}case"circle":w(k,n,r.props.color,r.props.radius,i,a,f,r.props.opacity*t.opacity,!1);break;case"text":D(r.props,t.opacity)}r.props.mask&&P()}}else{if(0===r.props.length)return;const e=n;R(r.mask,s,t.transformation),function(e,t){const r=t.props.length-e.stateByIndex.length;if(r>0)for(let t=0;t<r;t++)e.stateByIndex.push({lineCaps:null,linePath:new Float32Array,strokePath:new Float32Array});else r<0&&(e.stateByIndex.length=t.props.length)}(e,r);for(let n=0;n<r.props.length;n++){const i=r.props[n];i.show&&(g(t.transformation,k,i),U(i,t.opacity,e.stateByIndex[n]))}r.mask&&P()}else{if(0===r.props.length)return;const e=n;R(r.mask,s,t.transformation),function(e,t){const r=t.props.length-e.pointsByIndex.length;if(r>0)for(let t=0;t<r;t++)e.pointsByIndex.push({points:new Float32Array});else r<0&&(e.pointsByIndex.length=t.props.length)}(e,r);for(let n=0;n<r.props.length;n++){const o=r.props[n];o.show&&(g(t.transformation,k,o),w(k,e.pointsByIndex[n],o.color,o.radius,i,a,f,o.opacity*t.opacity,!1))}r.mask&&P()}else{if(0===r.props.length)return;R(r.mask,s,t.transformation);for(const e of r.props)e.show&&(g(t.transformation,k,e),D(e,t.opacity));r.mask&&P()}},startNativeSprite:()=>{r.bindVertexArrayOES(null)},endNativeSprite:()=>{h.program=null,h.texture=null,e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)},getInitTextureState:e=>{switch(e.type){case"imageArray":return{matrices:new Float32Array,opacities:new Float32Array};case"line":return{lineCaps:null,linePath:new Float32Array,strokePath:new Float32Array};case"circle":return{points:new Float32Array};case"rectangleArray":return{matrices:new Float32Array,colours:new Float32Array};case"circleArray":return{pointsByIndex:Array.from({length:e.array().length}).map((()=>({points:new Float32Array})))};case"lineArray":return{stateByIndex:Array.from({length:e.array().length}).map((()=>({lineCaps:null,linePath:new Float32Array,strokePath:new Float32Array})))};default:return null}},getInitMaskState:e=>{if(null===e)return{value:null};switch(e.type){case"lineMask":return{value:{type:e.type,lineCaps:null,linePath:new Float32Array,strokePath:new Float32Array}};case"circleMask":return{value:{type:e.type,points:new Float32Array}};case"rectangleMask":return{value:null}}}}}const ae=(e,t)=>{const r=e[t];if(!r)throw Error(`Image file "${t}" was not preloaded`);if("then"in r.data)throw Error(`Image file "${t}" did not finish loading before it was used`);return r.data},oe={family:"sans-serif",size:12};function se({id:e,message:t="",message2:r="",message3:n="",message4:i="",message5:a=""}){return new Promise((o=>{new Promise((t=>{let r=window.__replayGlobalCallbacks__;r||(r={},window.__replayGlobalCallbacks__=r),r[e]=e=>{t(e)}})).then((t=>{window.__replayGlobalCallbacks__[e]=void 0,o(t)})),window.Android.bridge(e,t,r,n,i,a)}))}function le(e){return new Promise((function(t,r){const n=new XMLHttpRequest;n.onload=function(){t(new Response(n.response,{status:n.status}))},n.onerror=function(){r(new TypeError(`Failed to load file: ${e.toString()}`))},n.open("GET",e),n.responseType="arraybuffer",n.send(null)}))}function ce(){return"undefined"!=typeof game&&game.Game?function(e,t,r){const{dimensions:n="game-coords",canvas:i,nativeSpriteMap:a={},windowSize:o,statsBegin:s,statsEnd:l,imageResolution:u=3,maxPixels:d}=t||{},p=i||document.createElement("canvas");i||document.body.appendChild(p),p.id="replay-canvas";const f=document.createElement("canvas"),m=window.PointerEvent?"pointerdown":"touchstart",h=window.PointerEvent?"pointermove":"touchmove",y=window.PointerEvent?"pointerup":"touchend",v=window.PointerEvent?"pointercancel":"touchcancel",x=p.getContext("webgl",{stencil:!0});if(!x)return Error("WebGL not supported");const _=x,b=_.getExtension("ANGLE_instanced_arrays");if(!b)return Error("WebGL instancing not supported");const T=b,R=_.getExtension("OES_vertex_array_object");if(!R)return Error("WebGL VAO not supported");const P=R;_.enable(_.BLEND),_.blendFunc(_.ONE,_.ONE_MINUS_SRC_ALPHA),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);const F=new(window.AudioContext||window.webkitAudioContext);let I=!0,k=!0,L=0,M=!1,C=0,j=0;const J=()=>{document.hidden&&k&&(C=L,F.suspend()),document.hidden||k||(M=!0,setTimeout((()=>{F.suspend(),setTimeout((()=>{F.resume()}),75)}),75)),k=!document.hidden};document.addEventListener("keydown",(e=>{I&&!e.repeat&&N(e)}),!1),document.addEventListener("keyup",(e=>{I&&B(e)}),!1),document.addEventListener("visibilitychange",J,!1),window.addEventListener("resize",re,!1);const K=()=>re({didScroll:!0});let q,Q,Z,ee,te;function re(t){const r=Boolean(t&&"cleanup"in t&&t.cleanup),i=Boolean(t&&"didScroll"in t&&t.didScroll);if(q&&(document.removeEventListener(m,Q),document.removeEventListener(h,Z),document.removeEventListener(y,ee),document.removeEventListener(v,te),r))return;i&&q||(pe.size=z((null==o?void 0:o.width)||window.innerWidth,(null==o?void 0:o.height)||window.innerHeight,n,e.props.size));const a=window.devicePixelRatio||1,s=pe.size.deviceWidth*a*de.resolution,l=pe.size.fullWidth*u;let c,g;s>l?(c=Math.round(l),g=Math.round(pe.size.fullHeight*u)):(c=Math.round(s),g=Math.round(pe.size.deviceHeight*a*de.resolution));const x=c/pe.size.fullWidth;if(d&&!de.hasSet&&c*g>d&&de.resolution>.15)return de.resolution-=.1,void re();p.width=c,p.height=g,p.style.width=`${pe.size.deviceWidth}px`,p.style.height=`${pe.size.deviceHeight}px`;const A=e.props.defaultFont||oe,b=e.props.backgroundColor||"white",S=pe.size.width+2*pe.size.widthMargin,E=pe.size.height+2*pe.size.heightMargin,w=ie(_,T,P,f,S,E,ae,A,b,x),R=pe.size.deviceWidth/S;ue.newFrame=w.newFrame,ue.endFrame=w.endFrame,ue.startRenderSprite=w.startRenderSprite,ue.endRenderSprite=w.endRenderSprite,ue.renderTexture=w.renderTexture,ue.startNativeSprite=w.startNativeSprite,ue.endNativeSprite=w.endNativeSprite,ue.getInitTextureState=w.getInitTextureState,ue.getInitMaskState=w.getInitMaskState,me.gameXToPlatformX=(({canvasOffsetLeft:e,widthMargin:t,scale:r,width:n})=>i=>e+r*(i+n/2+t))({canvasOffsetLeft:p.offsetLeft,width:pe.size.width,widthMargin:pe.size.widthMargin,scale:R}),me.gameYToPlatformY=(({canvasOffsetTop:e,heightMargin:t,scale:r,height:n})=>i=>e-r*(i-n/2-t))({canvasOffsetTop:p.offsetTop,height:pe.size.height,heightMargin:pe.size.heightMargin,scale:R}),me.didResize=!0,me.scale=R,me.size=pe.size;const F=(({canvasOffsetLeft:e,scrollX:t,widthMargin:r,scale:n,width:i})=>a=>(a.clientX-e+t)/n-r-i/2)({canvasOffsetLeft:p.offsetLeft,scrollX:window.scrollX,width:pe.size.width,widthMargin:pe.size.widthMargin,scale:R}),k=(({canvasOffsetTop:e,scrollY:t,heightMargin:r,scale:n,height:i})=>a=>-(a.clientY-e+t)/n+r+i/2)({canvasOffsetTop:p.offsetTop,scrollY:window.scrollY,height:pe.size.height,heightMargin:pe.size.heightMargin,scale:R}),L=(e,t)=>e>pe.size.width/2+pe.size.widthMargin||e<-pe.size.width/2-pe.size.widthMargin||t>pe.size.height/2+pe.size.heightMargin||t<-pe.size.height/2-pe.size.heightMargin;Q=e=>{if("changedTouches"in e){I=!1;for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t],n=F({clientX:r.screenX}),i=k({clientY:r.screenY});L(n,i)||(I=!0,O(n,i,r.identifier))}return}const t=F(e),r=k(e);L(t,r)?I=!1:(I=!0,O(t,r,e.pointerId))},Z=e=>{if("changedTouches"in e){for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t],n=F({clientX:r.screenX}),i=k({clientY:r.screenY});L(n,i)||Y(n,i)}return}const t=F(e),r=k(e);L(t,r)||Y(t,r)},ee=e=>{if("changedTouches"in e){for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t],n=F({clientX:r.screenX}),i=k({clientY:r.screenY});L(n,i)?X(r.identifier):V(n,i,r.identifier)}return}const t=F(e),r=k(e);L(t,r)?X(e.pointerId):V(t,r,e.pointerId)},te=e=>{if("changedTouches"in e)for(let t=0;t<e.changedTouches.length;t++)X(e.changedTouches[t].identifier);else X(e.pointerId)},document.addEventListener(m,Q,!1),document.addEventListener(h,Z,!1),document.addEventListener(y,ee,!1),document.addEventListener(v,te,!1),q=pe.size}window.addEventListener("scroll",K,!1),document.addEventListener("contextmenu",(e=>{e.preventDefault()}));const ne={},ae={},se=(e,t)=>()=>{throw Error(`Failed to load ${e} file "${t}"`)},le=(null==r?void 0:r.fileFetch)||fetch,ce={audioElements:ne,imageElements:ae,loadAudioFile:e=>async function(e,t){const r=await t,n=await r.arrayBuffer();return await new Promise(((t,r)=>{e.decodeAudioData(n,t,r)}))}(F,le(e)).then((e=>({buffer:e,volume:1}))).catch(se("audio",e)),loadImageFile:(e,t)=>new Promise(((r,n)=>{const i=new Image;i.addEventListener("load",(()=>{r(function(e,t,r){const n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),r?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)):e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);const i={texture:n,image:t};return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),i}(_,i,t))})),i.addEventListener("error",n),i.src=e})).catch(se("image",e)),cleanupAudioFile:e=>{const{data:t}=ne[e];!("then"in t)&&t.playState&&(t.playState.sample.onended=null,t.playState.sample.disconnect(),t.playState.sample.buffer=null)},cleanupImageFile:e=>{const{data:t}=ae[e];"then"in t||_.deleteTexture(t.texture)}},ue={newFrame:()=>null,endFrame:()=>null,startRenderSprite:()=>null,endRenderSprite:()=>null,renderTexture:()=>null,startNativeSprite:()=>null,endNativeSprite:()=>null,getInitTextureState:()=>null,getInitMaskState:()=>({value:null})},de={resolution:1,hasSet:!1,get(){return this.resolution},set(e){this.resolution=e,this.hasSet=!0,re(),pe.storage.setItem(H,String(e))}},pe=function(e,t,r,n,i){return{isTouchScreen:!!("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)||window.matchMedia("(touch-enabled),(-webkit-touch-enabled),(-moz-touch-enabled),(-o-touch-enabled),(-ms-touch-enabled)").matches,log:console.log,random:Math.random,timer:$(),audio:W(e,r.audioElements),assetUtils:r,network:{get:(e,t)=>{fetch(e).then((e=>e.json())).then(t)},post:(e,t,r)=>{fetch(e,{method:"POST",body:JSON.stringify(t)}).then((e=>e.json())).then(r)},put:(e,t,r)=>{fetch(e,{method:"PUT",body:JSON.stringify(t)}).then((e=>e.json())).then(r)},delete:(e,t)=>{fetch(e,{method:"DELETE"}).then((e=>e.json())).then(t)}},storage:{getItem:async e=>localStorage.getItem(e),setItem:async(e,t)=>{null!==t?localStorage.setItem(e,t):localStorage.removeItem(e)}},alert:{ok:(e,t)=>{alert(e),null==t||t()},okCancel:(e,t)=>{t(confirm(e))}},clipboard:{copy:(e,t)=>{navigator.clipboard?navigator.clipboard.writeText(e).then((()=>{t()})).catch((e=>{t(e)})):t(new Error(window.isSecureContext?"Couldn't access clipboard":"Clipboard only available on HTTPS or localhost"))}},size:t,now:()=>new Date,resolution:i,...n}}(F,z((null==o?void 0:o.width)||window.innerWidth,(null==o?void 0:o.height)||window.innerHeight,n,e.props.size),ce,(null==r?void 0:r.device)||{},de);pe.storage.getItem(H).then((e=>{if(null!==e){const t=Number(e);isNaN(t)||de.set(t)}}));const fe={mutDevice:pe,getInputs:U,newInputs:D,render:ue,isTestPlatform:!1},me={isLastFrame:!0,didResize:!1,scale:1,gameXToPlatformX:e=>e,gameYToPlatformY:e=>e,size:pe.size};let he=!1;const ge=()=>{document.removeEventListener("keydown",ge,!1),document.removeEventListener(m,ge,!1),"suspended"===F.state&&F.resume(),F.onstatechange=()=>{"suspended"!==F.state||document.hidden||F.resume()}};return document.addEventListener("keydown",ge,!1),document.addEventListener(m,ge,!1),function t(){const r=(null==o?void 0:o.width)||window.innerWidth,n=(null==o?void 0:o.height)||window.innerHeight;if(!r||!n)return void setTimeout(t,50);re();const{runNextFrame:i}=function(e,t,r,n){const{mutDevice:i,getInputs:a,newInputs:o,isTestPlatform:s}=e,l={index:0,stack:[{opacity:1,transformation:c.getScaleMatrix(2/i.size.fullWidth,2/i.size.fullHeight),transformationGameCoords:[...c.identityMatrix],hasMask:!1}]},u=[0,0,0,0,0,0],d=[0,0,0,0,0,0],p={addToStack:e=>{const t=l.stack[l.index];g(t.transformation,u,e),g(t.transformationGameCoords,d,e),l.index++;const r=l.stack[l.index];if(r){r.opacity=t.opacity*e.opacity,r.hasMask=null!==e.mask;for(let e=0;e<u.length;e++)r.transformation[e]=u[e];for(let e=0;e<d.length;e++)r.transformationGameCoords[e]=d[e];return r}{const r=[...u],n=[...d],i={opacity:t.opacity*e.opacity,hasMask:null!==e.mask,transformation:r,transformationGameCoords:n};return l.stack.push(i),i}},removeFromStack:()=>{const e=l.stack[l.index];return l.index--,e},getStack:e=>l.stack[e],getStackIndex:()=>l.index,getTopStack:()=>l.stack[l.index]},f=E(r,i,a,o,p,0,r.props.id,[]),m=r.props.size,h=w(i.size,m);let y=0,v=0;const x={isEmpty:!1,newFrame:e.render.newFrame,endFrame:e.render.endFrame,startRenderSprite:e.render.startRenderSprite,endRenderSprite:e.render.endRenderSprite,renderTexture:e.render.renderTexture,startNativeSprite:e.render.startNativeSprite,endNativeSprite:e.render.endNativeSprite,getInitTextureState:e.render.getInitTextureState,getInitMaskState:e.render.getInitMaskState};x.newFrame(),A(f,r.props,i,p,a,o,!0,h,0,r.props.id,t,x,s,[]),x.endFrame();const _=()=>null,b=()=>null,T=()=>null,R=()=>null,P=()=>null,F=()=>null,I=()=>null;return e.render.getInitTextureState,e.render.getInitMaskState,{runNextFrame(n,u){const d=n-y;y=n,v+=d;let h=Math.floor(v/S);for(t.nativeSpriteUtils.didResize&&(l.stack[0].transformation=c.getScaleMatrix(2/i.size.fullWidth,2/i.size.fullHeight));h>0;){v-=S,h--;const n=v/S,l=w(i.size,m),c=0===h;c&&x.isEmpty?(x.isEmpty=!1,x.newFrame=e.render.newFrame,x.endFrame=e.render.endFrame,x.startRenderSprite=e.render.startRenderSprite,x.endRenderSprite=e.render.endRenderSprite,x.renderTexture=e.render.renderTexture,x.startNativeSprite=e.render.startNativeSprite,x.endNativeSprite=e.render.endNativeSprite):c||x.isEmpty||(x.isEmpty=!0,x.newFrame=_,x.endFrame=b,x.startRenderSprite=T,x.endRenderSprite=R,x.renderTexture=P,x.startNativeSprite=F,x.endNativeSprite=I),t.nativeSpriteUtils.isLastFrame=c,x.newFrame(),A(f,r.props,i,p,a,o,!1,l,n,r.props.id,t,x,s,[]),x.endFrame(),t.nativeSpriteUtils.didResize=!1,u()}}}}(fe,{nativeSpriteMap:a,nativeSpriteUtils:me},e);let u=null;function d(){null==l||l(),window.requestAnimationFrame(p)}function p(e){he||(null==s||s(),null===u&&(u=e-1/60),k?(M&&(M=!1,j+=e-C),L=e,i(e-u-j,G),d()):d())}d()}(),{cleanup:function(){p.width=p.width,i||document.body.removeChild(p),he=!0,document.removeEventListener("keydown",N,!1),document.removeEventListener("keyup",B,!1),document.removeEventListener("visibilitychange",J,!1),window.removeEventListener("resize",re,!1),window.removeEventListener("scroll",K,!1),re({cleanup:!0})},audioElements:ne,imageElements:ae,audioContext:F}}(game.Game(game.gameProps),game.options,{fileFetch:le,device:{storage:{getItem:async e=>{const t=await se({id:`__internalReplayStorageGetItem-${e}`,message:e});if("error"in t)throw Error(t.error);return t.value},setItem:async(e,t)=>{if(null===t){const t=await se({id:`__internalReplayStorageRemoveItem-${e}`,message:e});if("string"==typeof t)throw Error(t);return}const r=await se({id:`__internalReplayStorageSetItem-${e}`,message:e,message2:t});if("string"==typeof r)throw Error(r)}},clipboard:{copy(e,t){se({id:"__internalReplayClipboardCopy",message:e}).then((()=>{t()}))}},alert:{ok:(e,t)=>{se({id:"__internalReplayAlertOk",message:e}).then((()=>{null==t||t()}))},okCancel:(e,t)=>{se({id:"__internalReplayAlertOkCancel",message:e}).then((e=>{t(e)}))}}}}):Error("Game is not defined")}})(),renderCanvas=t})();